---
title: "how_to_make_a_poster"
author: "Toshikazu, Matsumura"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{how_to_make_a_poster}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Setup

```{r setup}
library(tidyverse)
library(grid)
library(gridExtra)
library(ggposter)

  # constant values
full_w <- 841  # mm
half_w <- full_w / 2
full <- grid::unit(full_w, "mm")
half <- grid::unit(half_w, "mm")
shrink <- 1
space <- grid::unit(2, "mm")

  # chunk option
fig.width <- full_w / 25.4
out.width <- "100%"
fig.height <- 10
knitr::opts_chunk$set(fig.width = fig.width, out.width = out.width, fig.height = fig.height)
  # chunk template
knitr::opts_template$set(
  part = list(fig.width=8.3, out.width="100%", fig.height=4)
)
```


## Combine image grobs


```{r jpgs}
jpg_grobs <- 
  stringr::str_c("original_", c("small", "tall", "wide", "large"), ".jpg") %>%
  system.file("extdata", ., package="ggposter") %>%
  purrr::map(jpeg::readJPEG) %>%
  purrr::map(grid::rasterGrob)

fix_width_height <- combine_grobs(jpg_grobs, direction = "horizontal", width=half * shrink, unify="height", space=space)
fix_width_width  <- combine_grobs(jpg_grobs, direction = "horizontal", width=half * shrink, unify="width",  space=space)
stacked_image_grob <- 
  combine_grobs(fix_width_height, fix_width_width, direction = "vertical", unify="width",space=space)

grid.draw(stacked_image_grob)
```



```{r strings_and_images}
  # description
txt_ITEM_40  <- "COMBINE IMAGES<br>"
txt_BODY_41   <- "- appose_image_grobs() and stack_image_grobs().<br>"
txt_BODY_42   <- "- Import images and arrange them in a line (row or col).<br>"
txt_BODY_43   <- "- Unify height or width of images (argument: unify).<br>"
txt_BODY_44   <- "- Fix hole width and/or height of combined grob (argument: width, height).<br>"
txt_BODY_45   <- "- gridtext::textbox_grob() will wrap strings (insert line breaks) longer than specified widht automatically."
txt <- str_c(txt_ITEM_40, txt_BODY_41, txt_BODY_42, txt_BODY_43, txt_BODY_44, txt_BODY_45)
image_description <- gridtext::textbox_grob(txt, width=half * shrink, use_markdown=FALSE)
  # image_and_description <- stack_grobs_conv(image_description, stacked_image_grob, space=space)
image_and_description <- 
  combine_grobs(image_description, stacked_image_grob, direction = "vertical", unify = "as_is", space=space)

grid.draw(image_and_description)
  # convertUnit(grobHeight(image_and_description), "in")
```


## Use table


```{r opts.label="part"}
grid::grid.newpage()
head(iris) %>%
  booktab_table_grob(title="title words", caption="caption words", fontsize=20, shrink=0.5) %>%
  grid::grid.draw()
```

```{r opts.label="part"}
font_size_table <- 
  font_size_list %>%
  dplyr::filter(base_size==26) %>%
  booktab_table_grob(title="Font size of ggposter", fontsize=20, shrink=0.5)
base_size_table <- 
  font_size_list %>%
  dplyr::filter(ratio==1) %>%
  booktab_table_grob(title="Base font size of ggposter", caption="Font size increases every 1.2 times approximately.", fontsize=20, shrink=0.5)

grid::grid.draw(combine_grobs(font_size_table, base_size_table, direction="horizontal", unify="as_is", space=grid::unit(10, "mm")))
```

```{r opts.label="part"}
grid::grid.newpage()
head(iris) %>%
  gridExtra::tableGrob(rows=NULL, theme=gridExtra::ttheme_minimal()) %>%
  add_booktab(lwd_out=2, lwd_in=1) %>%
  add_annotation(title="title words", caption="caption words") %>%
  grid::grid.draw()
```


## With ggplot2 
  # (and cowplot)

```{r ggplot2, opts.label="part"}

library(grid)
 # fig
text <- stringr::str_c(rep("abc", 40), collapse=" ")

space <- grid::unit(1, "mm")
widths <- grid::unit(rep(50, 2), "mm")

fig <- 
  ggplot2::ggplot(mpg, aes(x=displ, y=hwy)) + 
  geom_point() + 
  theme_bw()
fontsize <- 8
shrink <- 1

grid::grid.draw(appose_fig_text(fig, text, fontsize=26, shrink=0.5))


   # title
title <- "Colab with ggplot2 and gridtext"
fontsize <- 60
gp_title <- grid::gpar(fontsize=fontsize)
 # text
txt_body_31 <- "As shown in this example, we can use ggplot object in ggposter. "
txt_body_32 <- "We can write description aroud it."
description <- stringr::str_c(txt_body_31, txt_body_32)
fontsize <- 30
lineheight <- 1.1
gp_text <- grid::gpar(fontsize=fontsize, lineheight=lineheight)
 # generate slide and draw
slide <- gen_slide(title, fig, description, gp_title, gp_text, width=half)
grid.newpage()
grid::grid.draw(slide)

description_1 <- 
  arrange_txt(
    txt_body_31, txt_body_32, 
    widths=half * shrink)
grid.newpage()
grid.draw(combine_grobs(ggplot2::ggplotGrob(fig), description_1, direction="horizontal", unify="width"))
```


# Example: ggposter

As an example, this vignette shows how to make a poster. 

## Title


```{r title}
txt_title  <- "How to Make a Poster with ggposter Package in R"
txt_subt   <- "For comfortable and tidy work"
txt_kw     <- "Key words: ggplot2, grid, gridtext, R"
txt_author <- "Toshikazu Matsumura, matutosi@gmail.com"
txt_affil <- "Konan Women's Univ., Japan"
```


```{r arrange_text}
title <- arrange_txt(
    txt_title, txt_subt, txt_kw, txt_author, txt_affil,
    x=0.5, y=0.5, hjust=c(rep(0.5, 3), rep(0, 2)), widths=full)
grid::grid.draw(title)

grid::grid.show.layout(title$frame$layout)  # show layout
grid::grid.draw(title)

```

## Objectives

Like title and other string, we can combine some items and sentences, as shown bellow. 

```{r objectives}
txt_ITEM_10  <- "OBJECTIVES"
txt_BODY_11   <- "- Want to use R throughout making a poster."
txt_BODY_12   <- "- To use grid and ggplot2 system."
txt_BODY_13   <- "- Not to make similar poster from scratch."

txt_ITEM_20  <- "BACKGROUNDS"
txt_BODY_21   <- "- No R packages or tools for making a poster."
txt_BODY_22  <- "- PowerPoint needs many manual procedures to uniform a style."
txt_BODY_23  <- "- If we can make a poster with R, no need to save and load plots."

objectives <- arrange_txt(
  txt_ITEM_10, 
  txt_BODY_11, txt_BODY_12, txt_BODY_13, 
  widths=half)

backgrounds <- arrange_txt(
  txt_ITEM_20, 
  txt_BODY_21, txt_BODY_22, txt_BODY_23, 
  widths=half)

grid::grid.show.layout(objectives$frame$layout)
grid::grid.show.layout(backgrounds$frame$layout)
grid.draw(objectives)
grid.newpage()
grid.draw(objectives)

```

## Conclusions

This is a simple sample, too. 

```{r conclusions}
txt_ITEM_30  <- "CONCLUSIONS"
txt_BODY_31   <- "- Please install from CRAN or GitHub."
txt_BODY_32   <- "- ggposter package can might be a alternative tool for making a poster and slides."
txt_BODY_33   <- "- Colaboration with ggplot2, gridtext or other package may produce more effects."
txt_BODY_34   <- "- Still in the development stage and can have bugs."
txt_BODY_35   <- "- Welcome your requests."
txt_BODY_36   <- "- ENJOY!"

conclusions <- arrange_txt(
  txt_ITEM_30, 
  txt_BODY_31, txt_BODY_32, txt_BODY_33, txt_BODY_34, txt_BODY_35, txt_BODY_36, 
  widths=half)
```

## Combine text 

Arranged text grob generated by `arrange_txt()` can be apposed and/or stacked by `stack_grobs_conv()` and `appose_grobs_conv()`. 

Objectives and backgrounds are stacked, and then apposed besides `conclusions`. 
At Last, title will be stacked above objectives and backgrounds. 
We can draw combined grob (part_1). 
In this case, the paper size is A4, so you can check small manuscript on a paper or your pc screen. 

```{r combine_part_1}
grid::grid.newpage()
part_1 <- 
  combine_grobs(title, 
    combine_grobs(
      combine_grobs(objectives, backgrounds, direction = "vertical", unify="as_is", space=space),
      conclusions, direction = "horizontal", unify="as_is", space=space), 
  direction = "vertical", unify="as_is", space=space)
grid.draw(part_1)
```


## Combine fig and table

```{r fig_font_size, opts.label="part"}
fig_font_size <- 
  font_size_list %>%
  ggplot2::ggplot(ggplot2::aes(x=base_size, y=size)) + 
    ggplot2::geom_point() + 
    ggplot2::theme_bw()


fig_font_size_grob <-
  fig_font_size %>%
  ggplotGrob() %>%
  fix_size(width=grid::unit(80, "mm"), shrink=shrink * 26 / 12)

grid.draw(fig_font_size_grob)



fig_description <- 
"
- ggposter include a series of font size.<br>
- Base font size for a poster is 22, 26 or 32 pt.<br>
- Font `size` used exactly in a poster will be selected automatically.<br>
  - eg. text name: txt_ITEM_05 font size for ITEM.<br>
- We can change font size according to preference.<br>
" %>%
  gridtext::textbox_grob(width=0.5*half, use_markdown=FALSE)

fig_apposed <- combine_grobs(fig_font_size_grob, fig_description, direction="horizontal", unify="as_is")
grid::grid.draw(fig_apposed)

```





```{r table_iris, opts.label="part"}
table_iris <- 
  head(iris) %>%
  gridExtra::tableGrob(rows=NULL, theme=gridExtra::ttheme_minimal())  %>%
  add_booktab(lwd_out=2, lwd_in=1) %>%
  grid::grid.draw()
table_description <- ""

```



## Rendering a poster

```{r rendering_and_save}
grid.newpage()

  # ggplot2::ggsave("d:/tmp.pdf", poster)
  # ggplot2::ggsave("d:/tmp.png", poster)
```

# Make a Slide


```{r slide, opts.label="part"}
library(grid)

fig <- 
  ggplot2::ggplot(mpg, aes(x=displ, y=hwy)) + 
  geom_point() +
  theme_bw()

  # text
t_1 <- "This is a sample text. "
t_2 <- "When longer than width, "
t_3 <- "text will be split and add breaks. "
t_4 <- "This text is separated into 5 objects, "
t_5 <- "because of R document specification."
text <- stringr::str_c(t_1, t_2, t_3, t_4, t_5)
  # gp_text
fontsize <- 20
lineheight <- 1.1
gp_text <- gpar(fontsize=fontsize, lineheight=lineheight)

  # title
title_1 <- "THIS IS TITLE WORDS"
  # gp_text
fontsize <- 40
gp_title <- gpar(fontsize=fontsize)

slide <- gen_slide(title_1, fig, text, gp_title, gp_text)
grid.draw(slide)
  # ggplot2::ggsave("d:/slide.pdf", slide, height=210, width=297, units="mm")

```



# Inside ggposter

ggposter is designed for making a poster and rendering speed is slow, 
because the 

## Combine ggobject and text grob 

We can combine ggplot object and text grob using gridExtra package. 

At first, generate ggplot object as below. 

```{r gg_obj, warning=FALSE, opts.label="part"}
gg_obj <- 
  ggplot2::ggplot(mpg) + 
  ggplot2::geom_point(aes(x = displ, y = hwy)) +
  ggplot2::theme_bw()
gg_obj  # draw ggplot object
```


```{r text}

  # tb <- txt2tibble(txt_body_1, txt_body_2, txt_body_3)
  # tb <- 
  # dplyr::mutate(font_size = purrr::pmap_dbl(tb, get_font_size)) %>%
  # dplyr::mutate(just="left") %>%
  # purrr::pmap(as_tg)
  # layout <- tg2layout(tg)
  # ar_tg <- tg_arrange(tg=tg, layout=layout)
```

Then, generate text grob as below. 
```{r text_grob2, warning=FALSE, opts.label="part"}
txt_body_1 <- "This graphics was generated using ggplot2. "
txt_body_2 <- "x axis is displ that means engine displacement in litres."
txt_body_3 <- "y axis is hwy that means highway miles per gallon."

tg_grob <- arrange_txt(txt_body_1, txt_body_2, txt_body_3)
grid::grid.draw(tg_grob)
grid::grid.newpage
```

Next, combine
```{r combine_gg_text, warning=FALSE, opts.label="part"}
gg_and_text <- gridExtra::grid.arrange(gg_obj, tg_grob, nrow=1, respect=c(TRUE, FALSE), widths=c(1,2))
grid::grid.draw(gg_and_text)
```

<!--
http://www.sthda.com/english/wiki/wiki.php?id_contents=7930
-->


## Table grob

We can make a table grob using `tableGrob()` in gridExtra, and draw it. 

```{r make_table, opts.label="part"}
font_size_table <- 
  font_size_list %>%
  dplyr::filter(base_size==26) %>%
  gridExtra::tableGrob(rows=NULL)

base_size_table <- 
  font_size_list %>%
  dplyr::filter(ratio==1) %>%
  gridExtra::tableGrob(rows=NULL)

grid::grid.draw(font_size_table)
```

Since the widths and heights given by these function might not be correct, 
thus the apposed or stacked table grob will be overwrapped. 
I can not exactly identify the code that causes this, I can not suggest fundamental solution to it. 
<!-- maybe bug of the function `row_heighst()` and `col_widths`.  -->


```{r apposed_table, opts.label="part"}
convertUnit(grobWidth(font_size_table), "mm")  # wrong unit
convertUnit(grobWidth(base_size_table), "mm")  # wrong unit
apposed <- combine_grobs(font_size_table, base_size_table, direction="horizontal", unify="as_is", space=space)
grid::grid.draw(apposed)
```

Using `fix_table_unit` make it possible to arrange table grobs at correct position. 
This function fix width and height of a table grob, 
so I recommend users not to use under other situations because of a table grob returned does not fit resized viewpot. 

```{r fixed_apposed_table, opts.label="part"}
font_size_table <- fix_table_unit(font_size_table)
base_size_table <- fix_table_unit(base_size_table)
convertUnit(grobWidth(font_size_table), "mm")  # correct unit
convertUnit(grobWidth(base_size_table), "mm")  # correct unit

apposed_fixed <- combine_grobs(font_size_table, base_size_table, direction="horizontal", unify="as_is", space=space)
grid::grid.draw(apposed_fixed)
```
